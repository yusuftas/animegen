<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Video Effects Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .clip-selector {
            margin-bottom: 20px;
        }

        .clip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .clip-card {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: #f8fafc;
        }

        .clip-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .clip-card.selected {
            border-color: #667eea;
            background: #edf2f7;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .clip-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .clip-source {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .effects-categories {
            margin-top: 20px;
        }

        .category {
            margin-bottom: 25px;
        }

        .category-header {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .category-header:hover {
            transform: translateX(5px);
        }

        .category-header.collapsed::after {
            content: '+';
            font-size: 1.2rem;
        }

        .category-header.expanded::after {
            content: '‚àí';
            font-size: 1.2rem;
        }

        .effects-list {
            background: #f8fafc;
            border-radius: 0 0 8px 8px;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .effects-list.expanded {
            padding: 15px;
            max-height: 1000px;
        }

        .effect-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
            overflow: hidden;
        }

        .effect-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .effect-header:hover {
            background: #edf2f7;
        }

        .effect-checkbox {
            margin-right: 10px;
        }

        .effect-name {
            font-weight: bold;
            color: #2d3748;
        }

        .effect-description {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 2px;
        }

        .effect-params {
            padding: 15px;
            background: white;
            display: none;
        }

        .effect-params.show {
            display: block;
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-label {
            display: block;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .param-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .param-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .control-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-1px);
        }

        .output-name {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }

        .status-panel {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .status-panel.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #667eea);
            width: 0%;
            transition: width 0.3s ease;
        }

        .error {
            color: #e53e3e;
            background: #fed7d7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .success {
            color: #38a169;
            background: #c6f6d5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .no-effects {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                text-align: center;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéå Anime Video Effects Studio</h1>
            <p>Transform your anime clips with professional effects</p>
        </div>

        {% if not effects_available %}
        <div class="no-effects">
            <h2>‚ö†Ô∏è Effects Not Available</h2>
            <p>The video effects modules are not properly installed.</p>
            <p>Please install the required dependencies and restart the application.</p>
        </div>
        {% else %}

        <div class="main-grid">
            <!-- Clip Selection Panel -->
            <div class="panel">
                <h2>üìÅ Select Video Clip</h2>
                
                <div class="clip-selector">
                    <div class="clip-grid" id="clipsGrid">
                        {% for clip in clips %}
                        <div class="clip-card" data-path="{{ clip.path }}">
                            <div class="clip-name">{{ clip.name }}</div>
                            <div class="clip-source">{{ clip.source }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="upload-area" id="uploadArea">
                    <p>üì§ Drop video files here or click to upload</p>
                    <input type="file" id="fileInput" accept="video/*" style="display: none;">
                </div>
            </div>

            <!-- Effects Selection Panel -->
            <div class="panel">
                <h2>‚ú® Select Effects</h2>
                
                <div class="effects-categories" id="effectsCategories">
                    {% for category_name, effects in effects_config.items() %}
                    <div class="category">
                        <div class="category-header collapsed" data-category="{{ category_name }}">
                            {{ category_name.replace('_', ' ').title() }}
                        </div>
                        <div class="effects-list" data-category="{{ category_name }}">
                            {% for effect_name, effect_config in effects.items() %}
                            <div class="effect-item">
                                <div class="effect-header">
                                    <div>
                                        <input type="checkbox" class="effect-checkbox" 
                                               data-category="{{ category_name }}" 
                                               data-effect="{{ effect_name }}">
                                        <span class="effect-name">{{ effect_config.name }}</span>
                                        <div class="effect-description">{{ effect_config.description }}</div>
                                    </div>
                                </div>
                                <div class="effect-params" data-category="{{ category_name }}" data-effect="{{ effect_name }}">
                                    {% for param_name, param_config in effect_config.parameters.items() %}
                                    <div class="param-group">
                                        <label class="param-label">{{ param_name.replace('_', ' ').title() }}</label>
                                        {% if param_config.type == 'select' %}
                                        <select class="param-input" data-param="{{ param_name }}">
                                            {% for option in param_config.options %}
                                            <option value="{{ option }}" {% if option == param_config.default %}selected{% endif %}>
                                                {{ option.title() }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% elif param_config.type == 'string' %}
                                        <input type="text" class="param-input" data-param="{{ param_name }}" 
                                               value="{{ param_config.default }}" placeholder="{{ param_config.default }}">
                                        {% elif param_config.type == 'list' %}
                                        <input type="text" class="param-input" data-param="{{ param_name }}" 
                                               value="{{ param_config.default }}" placeholder="{{ param_config.description }}">
                                        {% else %}
                                        <input type="number" class="param-input" data-param="{{ param_name }}" 
                                               value="{{ param_config.default }}" 
                                               {% if param_config.min is defined %}min="{{ param_config.min }}"{% endif %}
                                               {% if param_config.max is defined %}max="{{ param_config.max }}"{% endif %}
                                               {% if param_config.type == 'float' %}step="0.1"{% endif %}>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2>üé¨ Process Video</h2>
            <div class="controls">
                <input type="text" class="output-name" id="outputName" 
                       placeholder="Enter output filename..." value="processed_clip.mp4">
                <button class="btn btn-primary" id="processBtn">Apply Effects</button>
                <button class="btn btn-secondary" id="resetBtn">Reset</button>
                <button class="btn btn-secondary" id="previewBtn">Preview Settings</button>
            </div>

            <div class="status-panel" id="statusPanel">
                <div id="statusMessage">Processing...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="downloadLink"></div>
            </div>
        </div>

        {% endif %}
    </div>

    <script>
        // Global variables
        let selectedClip = null;
        let currentJobId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeClipSelection();
            initializeEffectsPanel();
            initializeFileUpload();
            initializeControls();
        });

        function initializeClipSelection() {
            const clipsGrid = document.getElementById('clipsGrid');
            if (!clipsGrid) return;

            clipsGrid.addEventListener('click', function(e) {
                const clipCard = e.target.closest('.clip-card');
                if (!clipCard) return;

                // Remove previous selection
                document.querySelectorAll('.clip-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select new clip
                clipCard.classList.add('selected');
                selectedClip = clipCard.dataset.path;
                
                console.log('Selected clip:', selectedClip);
            });
        }

        function initializeEffectsPanel() {
            // Category toggles
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const effectsList = document.querySelector(`.effects-list[data-category="${category}"]`);
                    
                    if (this.classList.contains('collapsed')) {
                        this.classList.remove('collapsed');
                        this.classList.add('expanded');
                        effectsList.classList.add('expanded');
                    } else {
                        this.classList.remove('expanded');
                        this.classList.add('collapsed');
                        effectsList.classList.remove('expanded');
                    }
                });
            });

            // Effect checkboxes
            document.querySelectorAll('.effect-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const category = this.dataset.category;
                    const effect = this.dataset.effect;
                    const paramsDiv = document.querySelector(`.effect-params[data-category="${category}"][data-effect="${effect}"]`);
                    
                    if (this.checked) {
                        paramsDiv.classList.add('show');
                    } else {
                        paramsDiv.classList.remove('show');
                    }
                });
            });
        }

        function initializeFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadFile(e.target.files[0]);
                }
            });
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    showSuccess('File uploaded successfully!');
                    // Refresh clips list
                    location.reload();
                }
            })
            .catch(error => {
                showError('Upload failed: ' + error.message);
            });
        }

        function initializeControls() {
            const processBtn = document.getElementById('processBtn');
            const resetBtn = document.getElementById('resetBtn');
            const previewBtn = document.getElementById('previewBtn');

            if (processBtn) {
                processBtn.addEventListener('click', processVideo);
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', resetForm);
            }

            if (previewBtn) {
                previewBtn.addEventListener('click', previewSettings);
            }
        }

        function processVideo() {
            if (!selectedClip) {
                showError('Please select a video clip first');
                return;
            }

            const outputName = document.getElementById('outputName').value || 'processed_clip.mp4';
            const effects = collectSelectedEffects();

            if (Object.keys(effects).length === 0) {
                showError('Please select at least one effect');
                return;
            }

            const requestData = {
                clip_path: selectedClip,
                effects: effects,
                output_name: outputName
            };

            showStatus('Starting processing...');

            fetch('/api/apply_effects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    currentJobId = data.job_id;
                    pollStatus();
                }
            })
            .catch(error => {
                showError('Processing failed: ' + error.message);
            });
        }

        function collectSelectedEffects() {
            const effects = {};

            document.querySelectorAll('.effect-checkbox:checked').forEach(checkbox => {
                const category = checkbox.dataset.category;
                const effect = checkbox.dataset.effect;
                
                if (!effects[category]) {
                    effects[category] = {};
                }

                // Collect parameters for this effect
                const params = {};
                const paramsDiv = document.querySelector(`.effect-params[data-category="${category}"][data-effect="${effect}"]`);
                
                paramsDiv.querySelectorAll('.param-input').forEach(input => {
                    const paramName = input.dataset.param;
                    params[paramName] = input.value;
                });

                effects[category][effect] = params;
            });

            return effects;
        }

        function pollStatus() {
            if (!currentJobId) return;

            fetch(`/api/status/${currentJobId}`)
                .then(response => response.json())
                .then(data => {
                    updateStatus(data);
                    
                    if (data.status === 'completed') {
                        showDownloadLink(data.output_file);
                    } else if (data.status === 'error') {
                        showError(data.message);
                    } else if (data.status !== 'not_found') {
                        // Continue polling
                        setTimeout(pollStatus, 1000);
                    }
                })
                .catch(error => {
                    console.error('Status polling error:', error);
                    setTimeout(pollStatus, 2000);
                });
        }

        function updateStatus(statusData) {
            const statusMessage = document.getElementById('statusMessage');
            const progressFill = document.getElementById('progressFill');
            
            if (statusMessage) {
                statusMessage.textContent = statusData.message || 'Processing...';
            }
            
            if (progressFill) {
                progressFill.style.width = (statusData.progress || 0) + '%';
            }
        }

        function showStatus(message) {
            const statusPanel = document.getElementById('statusPanel');
            const statusMessage = document.getElementById('statusMessage');
            const progressFill = document.getElementById('progressFill');
            
            if (statusPanel) {
                statusPanel.classList.add('show');
                statusMessage.textContent = message;
                progressFill.style.width = '0%';
            }
        }

        function showDownloadLink(filename) {
            const downloadLink = document.getElementById('downloadLink');
            if (downloadLink) {
                downloadLink.innerHTML = `
                    <div class="success">
                        ‚úÖ Processing completed! 
                        <a href="/api/download/${filename}" style="color: #38a169; text-decoration: underline;">
                            Download ${filename}
                        </a>
                    </div>
                `;
            }
        }

        function showError(message) {
            const statusPanel = document.getElementById('statusPanel');
            const downloadLink = document.getElementById('downloadLink');
            
            if (downloadLink) {
                downloadLink.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            }
            
            if (statusPanel) {
                statusPanel.classList.add('show');
            }
        }

        function showSuccess(message) {
            const downloadLink = document.getElementById('downloadLink');
            if (downloadLink) {
                downloadLink.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
            }
        }

        function resetForm() {
            // Reset clip selection
            document.querySelectorAll('.clip-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedClip = null;

            // Reset effect checkboxes
            document.querySelectorAll('.effect-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                const category = checkbox.dataset.category;
                const effect = checkbox.dataset.effect;
                const paramsDiv = document.querySelector(`.effect-params[data-category="${category}"][data-effect="${effect}"]`);
                paramsDiv.classList.remove('show');
            });

            // Reset status panel
            const statusPanel = document.getElementById('statusPanel');
            if (statusPanel) {
                statusPanel.classList.remove('show');
            }

            // Reset output name
            const outputName = document.getElementById('outputName');
            if (outputName) {
                outputName.value = 'processed_clip.mp4';
            }

            currentJobId = null;
        }

        function previewSettings() {
            const effects = collectSelectedEffects();
            const preview = {
                selectedClip: selectedClip,
                effects: effects,
                totalEffects: Object.keys(effects).reduce((sum, category) => {
                    return sum + Object.keys(effects[category]).length;
                }, 0)
            };

            alert(`Preview Settings:\n\nSelected Clip: ${selectedClip || 'None'}\nTotal Effects: ${preview.totalEffects}\n\nEffects Configuration:\n${JSON.stringify(effects, null, 2)}`);
        }
    </script>
</body>
</html>